<!-- === START: AI Chatbot Assistant === -->
<style>
/* ì±—ë´‡ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
.chatbot-container {
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 9999;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
}

.chatbot-toggle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
    position: relative;
}

.chatbot-toggle:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
}

.chatbot-toggle:active {
    transform: scale(0.95);
}

.chatbot-toggle .notification {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 12px;
    height: 12px;
    background: #ff4757;
    border-radius: 50%;
    border: 2px solid white;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
    100% { transform: scale(1); opacity: 1; }
}

.chatbot-window {
    position: absolute;
    bottom: 80px;
    left: 0;
    width: 380px;
    height: 600px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    display: none;
    flex-direction: column;
    overflow: hidden;
    transition: all 0.3s ease;
}

.chatbot-window.active {
    display: flex;
}

.chatbot-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chatbot-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
}

.chatbot-close {
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background 0.2s;
}

.chatbot-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

.chatbot-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.message {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 18px;
    line-height: 1.5;
    animation: messageSlide 0.3s ease;
}

@keyframes messageSlide {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.user {
    align-self: flex-end;
    background: #667eea;
    color: white;
    border-bottom-right-radius: 6px;
}

.message.bot {
    align-self: flex-start;
    background: #f1f3f5;
    color: #333;
    border-bottom-left-radius: 6px;
}

.message.streaming .message-content::after {
    content: 'â¬¤';
    color: #667eea;
    font-size: 12px;
    animation: blink 1s infinite;
    margin-left: 4px;
    vertical-align: baseline;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
}

.message .timestamp {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 4px;
}

.chatbot-input-container {
    padding: 16px;
    border-top: 1px solid #e9ecef;
    display: flex;
    gap: 10px;
}

.chatbot-input {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid #dee2e6;
    border-radius: 24px;
    outline: none;
    font-size: 14px;
    transition: border-color 0.2s;
}

.chatbot-input:focus {
    border-color: #667eea;
}

.chatbot-send {
    background: #667eea;
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.chatbot-send:hover {
    background: #5a67d8;
    transform: scale(1.05);
}

.chatbot-send:disabled {
    background: #adb5bd;
    cursor: not-allowed;
    transform: none;
}

.typing-indicator {
    display: none;
    align-self: flex-start;
    background: #f1f3f5;
    padding: 12px 20px;
    border-radius: 18px;
    border-bottom-left-radius: 6px;
}

.typing-indicator.active {
    display: block;
}

.typing-dots {
    display: flex;
    gap: 4px;
}

.typing-dots span {
    width: 8px;
    height: 8px;
    background: #667eea;
    border-radius: 50%;
    animation: typing 1.4s infinite;
}

.typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-10px); }
}

.error-message {
    color: #dc3545;
    font-size: 12px;
    margin-top: 8px;
}

.error-message {
    color: #dc3545;
    font-size: 12px;
    margin-top: 8px;
}

/* API í‚¤ ì…ë ¥ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
.api-key-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.api-key-modal.active {
    display: flex;
}

.api-key-modal-content {
    background: white;
    border-radius: 16px;
    padding: 24px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalSlide 0.3s ease;
}

@keyframes modalSlide {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.api-key-modal-header {
    text-align: center;
    margin-bottom: 20px;
}

.api-key-modal-header h3 {
    margin: 0;
    color: #333;
    font-size: 18px;
    font-weight: 600;
}

.api-key-modal-header p {
    margin: 8px 0 0 0;
    color: #666;
    font-size: 14px;
    line-height: 1.4;
}

.api-key-input-group {
    margin-bottom: 16px;
}

.api-key-input-group label {
    display: block;
    margin-bottom: 8px;
    color: #333;
    font-weight: 500;
    font-size: 14px;
}

.api-key-input-wrapper {
    position: relative;
}

.api-key-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    font-size: 14px;
    font-family: monospace;
    letter-spacing: 1px;
    box-sizing: border-box;
    transition: border-color 0.2s;
}

.api-key-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.api-key-visibility-toggle {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    font-size: 14px;
    transition: color 0.2s;
}

.api-key-visibility-toggle:hover {
    color: #333;
}

.api-key-modal-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
}

.api-key-modal-button {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 80px;
}

.api-key-confirm {
    background: #667eea;
    color: white;
}

.api-key-confirm:hover {
    background: #5a67d8;
    transform: translateY(-1px);
}

.api-key-confirm:disabled {
    background: #adb5bd;
    cursor: not-allowed;
    transform: none;
}

.api-key-cancel {
    background: #e9ecef;
    color: #495057;
}

.api-key-cancel:hover {
    background: #dee2e6;
}

.api-key-security-info {
    background: #f8f9fa;
    border-left: 4px solid #667eea;
    padding: 12px;
    margin-top: 16px;
    border-radius: 4px;
}

.api-key-security-info h4 {
    margin: 0 0 8px 0;
    color: #667eea;
    font-size: 13px;
    font-weight: 600;
}

.api-key-security-info ul {
    margin: 0;
    padding-left: 16px;
    color: #666;
    font-size: 12px;
    line-height: 1.5;
}

.api-key-security-info li {
    margin-bottom: 4px;
}

.api-key-security-info li:last-child {
    margin-bottom: 0;
}

/* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
@media (max-width: 480px) {
    .chatbot-container {
        left: 10px;
        bottom: 20px;
    }

    .chatbot-toggle {
        width: 56px;
        height: 56px;
        font-size: 22px;
    }

    .chatbot-window {
        width: calc(100vw - 20px);
        height: 70vh;
        left: 0;
        right: 10px;
    }

    .chatbot-messages {
        padding: 16px;
    }

    .message {
        max-width: 85%;
    }

    .api-key-modal-content {
        width: 95%;
        padding: 20px;
        margin: 20px;
    }

    .api-key-modal-buttons {
        flex-direction: column;
    }

    .api-key-modal-button {
        width: 100%;
    }
}
</style>

<div class="chatbot-container">
    <button class="chatbot-toggle" id="chatbotToggle" aria-label="AI ì±—ë´‡ ì—´ê¸°">
        <span>ğŸ¤–</span>
        <div class="notification" id="chatbotNotification" style="display: none;"></div>
    </button>

    <!-- API í‚¤ ì…ë ¥ ëª¨ë‹¬ (ê°„ë‹¨ í…ŒìŠ¤íŠ¸ ë²„ì „) -->
    <div class="api-key-modal" id="chatbotApiKeyModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; z-index: 99999;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; min-width: 420px; max-width: 90%; box-shadow: 0 10px 50px rgba(0,0,0,0.5);">
            <h3 style="margin-top: 0; color: #333; text-align: center;">ğŸ” API í‚¤ ì¸ì¦</h3>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">Z_API_KEYë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>

            <div style="margin-bottom: 20px;">
                <div style="background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #0c5460; font-size: 12px; line-height: 1.4;">
                        <strong>ğŸ”‘ API í‚¤ ë°œê¸‰ ë°©ë²•:</strong><br>
                        ì•„ë˜ ë§í¬ì—ì„œ ê°œì¸ API í‚¤ë¥¼ ë°œê¸‰ë°›ì•„ ì…ë ¥í•´ì£¼ì„¸ìš”<br>
                        <a href="https://z.ai/manage-apikey/apikey-list" target="_blank" style="color: #007bff; text-decoration: none; font-weight: 500;">
                            ğŸ”— https://z.ai/manage-apikey/apikey-list
                        </a>
                        <span style="color: #6c757d; font-size: 11px;"> (í´ë¦­í•˜ë©´ ìƒˆ ì°½ì—ì„œ ì—´ë¦½ë‹ˆë‹¤)</span>
                    </p>
                </div>

                <label style="display: block; margin-bottom: 8px; color: #333; font-weight: bold;">API í‚¤</label>
                <div style="position: relative;">
                    <input
                        type="password"
                        id="chatbotApiKeyInput"
                        placeholder="Z_API_KEYë¥¼ ì…ë ¥í•˜ì„¸ìš”... (ê°œì¸ì •ë³´ ë³´í˜¸ë¥¼ ìœ„í•´ ë¹„í‘œì‹œë©ë‹ˆë‹¤)"
                        style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: monospace;"
                        autocomplete="off"
                        spellcheck="false"
                    >
                    <button
                        type="button"
                        id="chatbotApiKeyToggle"
                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 16px;"
                        aria-label="API í‚¤ í‘œì‹œ/ìˆ¨ê¹€"
                    >ğŸ‘ï¸</button>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button
                    type="button"
                    id="chatbotApiKeyCancel"
                    style="flex: 1; padding: 12px; border: none; border-radius: 8px; background: #f5f5f5; color: #666; cursor: pointer; font-weight: bold;"
                >ì·¨ì†Œ</button>
                <button
                    type="button"
                    id="chatbotApiKeyConfirm"
                    disabled
                    style="flex: 1; padding: 12px; border: none; border-radius: 8px; background: #667eea; color: white; cursor: pointer; font-weight: bold;"
                >í™•ì¸</button>
            </div>

            <div style="background: #f8f9fa; border-left: 4px solid #667eea; padding: 15px; font-size: 12px; color: #666;">
                <h4 style="margin: 0 0 8px 0; color: #667eea;">ğŸ›¡ï¸ ë³´ì•ˆ ì•ˆë‚´</h4>
                <ul style="margin: 0; padding-left: 20px;">
                    <li>API í‚¤ëŠ” ì„œë²„ì— ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</li>
                    <li>í˜„ì¬ ì„¸ì…˜ì—ì„œë§Œ ì¼ì‹œì ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤</li>
                    <li>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ë‹¤ì‹œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤</li>
                    <li>ì•ˆì „í•œ ì²˜ë¦¬ë¥¼ ìœ„í•´ í‚¤ê°€ *ë¡œ í‘œì‹œë©ë‹ˆë‹¤</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="chatbot-window" id="chatbotWindow">
        <div class="chatbot-header">
            <h3>ğŸ¤– AI ì±—ë´‡</h3>
            <button class="chatbot-close" id="chatbotClose" aria-label="ì±—ë´‡ ë‹«ê¸°">âœ•</button>
        </div>

        <div class="chatbot-messages" id="chatbotMessages">
            <div class="message bot">
                <div>ì•ˆë…•í•˜ì„¸ìš”! AI ì±—ë´‡ì…ë‹ˆë‹¤. ğŸ˜Š</div>
                <div>ì´ í˜ì´ì§€ì˜ ë‚´ìš©ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ë¬¼ì–´ë³´ì„¸ìš”!</div>
                <div>âœ… API í‚¤ê°€ ì¸ì¦ë˜ì–´ ì±—ë´‡ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
                <div class="timestamp" id="welcomeTime"></div>
            </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <div class="chatbot-input-container">
            <input
                type="text"
                class="chatbot-input"
                id="chatbotInput"
                placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                aria-label="ë©”ì‹œì§€ ì…ë ¥"
            >
            <button class="chatbot-send" id="chatbotSend" aria-label="ë©”ì‹œì§€ ì „ì†¡">
                â¤
            </button>
        </div>

        <div class="error-message" id="errorMessage"></div>
    </div>
</div>

<script>
// ì±—ë´‡ JavaScript êµ¬í˜„ (API í‚¤ ì¸ì¦ ë³´ì•ˆ ë²„ì „)
(function() {
    // ì „ì—­ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    if (window.__CHATBOT_INSTALLED__) return;
    window.__CHATBOT_INSTALLED__ = true;

    // ì„¤ì • ë¡œë“œ ìƒíƒœ
    let configLoaded = false;
    let configLoadError = false;

    // API í‚¤ ìƒíƒœ ê´€ë¦¬
    let currentApiKey = null;
    let isApiKeyVerified = false;

    // API í‚¤ ê´€ë¦¬ í•¨ìˆ˜
    const apiKeyManager = {
        // API í‚¤ ì €ì¥ (ì„¸ì…˜ ë©”ëª¨ë¦¬ì—ë§Œ)
        setApiKey: function(key) {
            if (!key || typeof key !== 'string' || key.trim().length === 0) {
                return false;
            }
            currentApiKey = key.trim();
            isApiKeyVerified = true;
            return true;
        },

        // API í‚¤ ê°€ì ¸ì˜¤ê¸°
        getApiKey: function() {
            return isApiKeyVerified ? currentApiKey : null;
        },

        // API í‚¤ ì´ˆê¸°í™”
        clearApiKey: function() {
            currentApiKey = null;
            isApiKeyVerified = false;
        },

        // API í‚¤ê°€ ìˆëŠ”ì§€ í™•ì¸
        hasApiKey: function() {
            return isApiKeyVerified && currentApiKey !== null;
        }
    };

    // Netlify Functionsë¥¼ í†µí•œ ì„¤ì • ë¡œë“œ (API í‚¤ ë…¸ì¶œ ë°©ì§€)
    async function loadConfig() {
        if (configLoaded) return true;

        try {
            // ê°„ë‹¨í•œ ì„¤ì • ê°ì²´ ìƒì„± (API í‚¤ëŠ” ì‚¬ìš©ì ì…ë ¥ìœ¼ë¡œ ê´€ë¦¬)
            window.CHATBOT_SECURE_CONFIG = {
                getApiUrl: () => 'https://blogchatbot-proxy.netlify.app/api/chatbot', // Netlify Functions í”„ë¡ì‹œ ì‚¬ìš©
                getApiKey: () => apiKeyManager.getApiKey(), // ì‚¬ìš©ìê°€ ì…ë ¥í•œ API í‚¤ ì‚¬ìš©
                MODEL: 'glm-4.5',
                MAX_CALLS: 10,
                TIME_WINDOW: 3600000
            };
            configLoaded = true;
            return true;
        } catch (error) {
            console.warn('ì„¤ì • ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ì„¤ì • ì‚¬ìš©
            window.CHATBOT_SECURE_CONFIG = {
                getApiUrl: () => '/api/chatbot',
                getApiKey: () => apiKeyManager.getApiKey(),
                MODEL: 'glm-4.5',
                MAX_CALLS: 10,
                TIME_WINDOW: 3600000
            };
            configLoaded = true;
            return true;
        }
    }

    // DOM ìš”ì†Œ
    const chatbotToggle = document.getElementById('chatbotToggle');
    const chatbotWindow = document.getElementById('chatbotWindow');
    const chatbotClose = document.getElementById('chatbotClose');
    const chatbotMessages = document.getElementById('chatbotMessages');
    const chatbotInput = document.getElementById('chatbotInput');
    const chatbotSend = document.getElementById('chatbotSend');
    const typingIndicator = document.getElementById('typingIndicator');
    const errorMessage = document.getElementById('errorMessage');
    const welcomeTime = document.getElementById('welcomeTime');
    const chatbotNotification = document.getElementById('chatbotNotification');

    // API í‚¤ ëª¨ë‹¬ ê´€ë ¨ DOM ìš”ì†Œ (ID ë³€ê²½ìœ¼ë¡œ ì¶©ëŒ ë°©ì§€)
    const apiKeyModal = document.getElementById('chatbotApiKeyModal');
    const apiKeyInput = document.getElementById('chatbotApiKeyInput');
    const apiKeyToggle = document.getElementById('chatbotApiKeyToggle');
    const apiKeyConfirm = document.getElementById('chatbotApiKeyConfirm');
    const apiKeyCancel = document.getElementById('chatbotApiKeyCancel');

    // ì±—ë´‡ ìƒíƒœ
    let isOpen = false;
    let isProcessing = false;

    // API í‚¤ ëª¨ë‹¬ ê´€ë¦¬ í•¨ìˆ˜ (ê°„ë‹¨ ë²„ì „)
    function showApiKeyModal() {
        console.log('API í‚¤ ëª¨ë‹¬ í‘œì‹œ ì‹œë„');
        if (apiKeyModal) {
            apiKeyModal.style.display = 'flex';
            apiKeyInput.value = '';
            apiKeyInput.focus();
            updateApiKeyConfirmButton();
            console.log('API í‚¤ ëª¨ë‹¬ì´ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            console.error('API í‚¤ ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    function hideApiKeyModal() {
        console.log('API í‚¤ ëª¨ë‹¬ ìˆ¨ê¹€');
        if (apiKeyModal) {
            apiKeyModal.style.display = 'none';
            apiKeyInput.value = '';
            apiKeyInput.type = 'password';
            apiKeyToggle.textContent = 'ğŸ‘ï¸';
            updateApiKeyConfirmButton();
        }
    }

    function updateApiKeyConfirmButton() {
        const hasValidKey = apiKeyInput.value.trim().length > 0;
        apiKeyConfirm.disabled = !hasValidKey;
    }

    function toggleApiKeyVisibility() {
        const isPassword = apiKeyInput.type === 'password';
        apiKeyInput.type = isPassword ? 'text' : 'password';
        apiKeyToggle.textContent = isPassword ? 'ğŸ™ˆ' : 'ğŸ‘ï¸';
    }

    function confirmApiKey() {
        const apiKey = apiKeyInput.value.trim();
        if (apiKey.length === 0) {
            showError('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (apiKeyManager.setApiKey(apiKey)) {
            hideApiKeyModal();
            // ì±—ë´‡ ì°½ ì—´ê¸°
            openChatbotWindow();
            console.log('API í‚¤ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. (ì„¸ì…˜ ë©”ëª¨ë¦¬ì—ë§Œ ì €ì¥)');
        } else {
            showError('ìœ íš¨í•˜ì§€ ì•Šì€ API í‚¤ì…ë‹ˆë‹¤.');
        }
    }

    // ì´ˆê¸°í™” í•¨ìˆ˜
    async function initChatbot() {
        try {
            await loadConfig();

            // í™˜ì˜ ë©”ì‹œì§€ ì‹œê°„ ì„¤ì •
            if (welcomeTime) {
                welcomeTime.textContent = new Date().toLocaleTimeString('ko-KR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            console.log('AI ì±—ë´‡ì´ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. (ë³´ì•ˆ ê°•í™” ë²„ì „)');

        } catch (error) {
            console.error('ì±—ë´‡ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            // ì‹¤íŒ¨í•´ë„ ì±—ë´‡ì€ ê³„ì† í‘œì‹œí•˜ì§€ë§Œ API ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”
            if (chatbotToggle) {
                chatbotToggle.style.opacity = '0.5';
                chatbotToggle.style.cursor = 'not-allowed';
            }
            showError('ì±—ë´‡ ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
    }

    // í˜¸ì¶œ ì œí•œ í™•ì¸ (ì™„ì „íˆ ì œê±°ë¨ - í•­ìƒ í—ˆìš©)
    function checkRateLimit() {
        // ê°œì¸ ë¸”ë¡œê·¸ìš©ìœ¼ë¡œ ì œí•œì„ ì™„ì „íˆ ì œê±°í•˜ì—¬ ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ
        return true; // í•­ìƒ í—ˆìš©
    }

    // í˜ì´ì§€ ë‚´ìš© ì¶”ì¶œ í•¨ìˆ˜ (í‘œ ë°ì´í„° í¬í•¨ ê°œì„  ë²„ì „)
    function extractPageContent() {
        // ì½˜ì†”ì— ë””ë²„ê¹… ì •ë³´ ì¶œë ¥ (ê°œë°œ ì¤‘ í™•ì¸ìš©)
        console.log('ì½˜í…ì¸  ì¶”ì¶œ ì‹œì‘...');

        // ë³¸ë¬¸ ì½˜í…ì¸  ì˜ì—­ ì°¾ê¸° (ìš°ì„ ìˆœìœ„ë³„)
        let contentElement = null;
        const possibleSelectors = [
            '.entry-content',
            '.post-body',
            '.article-content',
            '.post-content',
            '.blog-content',
            '.content',
            'main',
            '#content',
            '#main',
            '.main-content',
            '#post-content',
            '.entry-content div'
        ];

        for (const selector of possibleSelectors) {
            const element = document.querySelector(selector);
            if (element && element.textContent.trim().length > 50) {
                contentElement = element;
                console.log(`ì½˜í…ì¸  ì˜ì—­ ì°¾ìŒ: ${selector}, í…ìŠ¤íŠ¸ ê¸¸ì´: ${element.textContent.length}`);
                break;
            }
        }

        // ì ì ˆí•œ ì½˜í…ì¸  ì˜ì—­ì„ ì°¾ì§€ ëª»í•œ ê²½ìš°, ì „ì²´ bodyì—ì„œ ì¶”ì¶œ ì‹œë„
        if (!contentElement) {
            console.log('ì ì ˆí•œ ì½˜í…ì¸  ì˜ì—­ì„ ì°¾ì§€ ëª»í•¨, bodyì—ì„œ ì¶”ì¶œ ì‹œë„');
            const bodyClone = document.body.cloneNode(true);

            // ì œì™¸í•  ìš”ì†Œë“¤ ì œê±°
            const excludeSelectors = [
                'script', 'style', 'noscript', 'iframe', 'nav', '.nav', '.navigation',
                '.sidebar', '.menu', '.comment', '.comments', '.footer', '.header',
                '.advertisement', '.ad', '.ads', '.widget', '.sidebar-widget',
                '.social-share', '.related-posts', '.tags', '.categories'
            ];

            excludeSelectors.forEach(sel => {
                bodyClone.querySelectorAll(sel).forEach(el => el.remove());
            });

            contentElement = bodyClone;
        }

        if (!contentElement || !contentElement.textContent) {
            console.log('ì½˜í…ì¸ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            return '';
        }

        // ì œëª© ì¶”ì¶œ
        const title = document.querySelector('h1')?.textContent ||
                     document.querySelector('.entry-title')?.textContent ||
                     document.querySelector('.post-title')?.textContent ||
                     document.querySelector('h2')?.textContent ||
                     document.title || '';

        console.log(`ì¶”ì¶œëœ ì œëª©: ${title}`);

        // ë³¸ë¬¸ ë‚´ìš© ì¶”ì¶œ - ê°œì„ ëœ ë²„ì „ (í‘œ ë°ì´í„° í¬í•¨)
        let content = '';
        let extractedElements = 0;

        // 1. ë‹¨ë½ ì¶”ì¶œ
        const paragraphs = contentElement.querySelectorAll('p');
        paragraphs.forEach(p => {
            const text = p.textContent.trim();
            if (text && text.length > 10 && !isAdOrNavigation(text)) {
                content += text + '\n\n';
                extractedElements++;
            }
        });

        // 2. í‘œ ë°ì´í„° ì¶”ì¶œ (ì¤‘ìš” ê°œì„ )
        const tables = contentElement.querySelectorAll('table');
        tables.forEach((table, tableIndex) => {
            console.log(`í‘œ ${tableIndex + 1} ë°œê²¬`);
            let tableText = `\n[í‘œ ${tableIndex + 1}]\n`;
            
            // í…Œì´ë¸” ìº¡ì…˜ ì¶”ì¶œ
            const caption = table.querySelector('caption');
            if (caption) {
                tableText += `í‘œ ì œëª©: ${caption.textContent.trim()}\n`;
            }
            
            // í…Œì´ë¸” í—¤ë” ì¶”ì¶œ
            const headers = table.querySelectorAll('thead th, thead td, tr:first-child th, tr:first-child td');
            if (headers.length > 0) {
                tableText += 'í—¤ë”: ';
                headers.forEach((header, index) => {
                    tableText += header.textContent.trim();
                    if (index < headers.length - 1) tableText += ' | ';
                });
                tableText += '\n';
            }
            
            // í…Œì´ë¸” ë³¸ë¬¸ ë°ì´í„° ì¶”ì¶œ (ìµœëŒ€ 10í–‰)
            const rows = table.querySelectorAll('tbody tr, tr:not(:first-child)');
            let rowCount = 0;
            rows.forEach(row => {
                if (rowCount >= 10) return; // ìµœëŒ€ 10í–‰ê¹Œì§€ ì¶”ì¶œ
                
                const cells = row.querySelectorAll('td, th');
                if (cells.length > 0) {
                    tableText += `${rowCount + 1}í–‰: `;
                    cells.forEach((cell, index) => {
                        tableText += cell.textContent.trim();
                        if (index < cells.length - 1) tableText += ' | ';
                    });
                    tableText += '\n';
                    rowCount++;
                }
            });
            
            if (rowCount > 0) {
                content += tableText + '\n';
                extractedElements++;
            }
        });

        // 3. ë¦¬ìŠ¤íŠ¸ ë°ì´í„° ì¶”ì¶œ
        const lists = contentElement.querySelectorAll('ul, ol');
        lists.forEach((list, listIndex) => {
            console.log(`ë¦¬ìŠ¤íŠ¸ ${listIndex + 1} ë°œê²¬`);
            let listText = `\n[ë¦¬ìŠ¤íŠ¸ ${listIndex + 1}]\n`;
            
            const items = list.querySelectorAll('li');
            items.forEach((item, index) => {
                const text = item.textContent.trim();
                if (text && !isAdOrNavigation(text)) {
                    listText += `${index + 1}. ${text}\n`;
                }
            });
            
            if (items.length > 0) {
                content += listText + '\n';
                extractedElements++;
            }
        });

        // 4. ì œëª© ì¶”ì¶œ (h1-h6)
        const headings = contentElement.querySelectorAll('h1, h2, h3, h4, h5, h6');
        headings.forEach(heading => {
            const text = heading.textContent.trim();
            if (text && !isAdOrNavigation(text)) {
                content += `[${heading.tagName}] ${text}\n\n`;
                extractedElements++;
            }
        });

        // 5. ì½”ë“œ ë¸”ë¡ ì¶”ì¶œ
        const codeBlocks = contentElement.querySelectorAll('pre, code');
        codeBlocks.forEach((block, index) => {
            const text = block.textContent.trim();
            if (text && text.length > 5) {
                content += `[ì½”ë“œ ë¸”ë¡ ${index + 1}]\n${text.substring(0, 500)}${text.length > 500 ? '...' : ''}\n\n`;
                extractedElements++;
            }
        });

        // 6. ê¸°íƒ€ ì¤‘ìš” ìš”ì†Œ ì¶”ì¶œ (div ë“±)
        if (extractedElements < 5) { // ì¶”ì¶œëœ ìš”ì†Œê°€ ë¶€ì¡±í•œ ê²½ìš°
            const otherElements = contentElement.querySelectorAll('div[class*="content"], div[class*="text"], div[class*="body"]');
            otherElements.forEach(element => {
                const text = element.textContent.trim();
                if (text && text.length > 20 && !isAdOrNavigation(text)) {
                    content += text + '\n\n';
                    extractedElements++;
                }
            });
        }

        // ê´‘ê³  ë° ë„¤ë¹„ê²Œì´ì…˜ í…ìŠ¤íŠ¸ í•„í„°ë§ í•¨ìˆ˜
        function isAdOrNavigation(text) {
            const adKeywords = [
                'ê´‘ê³ ', 'AD', 'ad', 'ìŠ¤í°ì„œ', 'sponsor', 'ì¶”ì²œ', 'ê´€ë ¨ê¸€', 'ê´€ë ¨ ìƒí’ˆ',
                'êµ¬ë§¤', 'íŒë§¤', 'ê°€ê²©', 'í• ì¸', 'ì¿ í°', 'ì´ë²¤íŠ¸', 'í´ë¦­', 'ë°”ë¡œê°€ê¸°',
                'ë”ë³´ê¸°', 'ê³µìœ ', 'ëŒ“ê¸€', 'ì¹´í…Œê³ ë¦¬', 'íƒœê·¸', 'ì‘ì„±ì¼', 'ì¡°íšŒìˆ˜'
            ];

            const navigationKeywords = [
                'ë©”ë‰´', 'MENU', 'home', 'í™ˆ', 'about', 'ì†Œê°œ', 'contact', 'ì—°ë½ì²˜',
                'login', 'ë¡œê·¸ì¸', 'join', 'ê°€ì…', 'search', 'ê²€ìƒ‰', 'link', 'ë§í¬'
            ];

            const lowerText = text.toLowerCase();
            return adKeywords.some(keyword => lowerText.includes(keyword.toLowerCase())) ||
                   navigationKeywords.some(keyword => lowerText.includes(keyword.toLowerCase())) ||
                   text.length < 10;
        }

        // ì½˜í…ì¸  ì •ë¦¬
        content = content.replace(/\n{3,}/g, '\n\n').trim();

        // ì—¬ì „íˆ ì½˜í…ì¸ ê°€ ë¶€ì¡±í•œ ê²½ìš°, ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ëŒ€ì²´
        if (content.length < 200) {
            console.log('ì½˜í…ì¸ ê°€ ë¶€ì¡±í•˜ì—¬ ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ëŒ€ì²´ ì¶”ì¶œ');
            const fallbackContent = contentElement.textContent;
            const cleanText = fallbackContent.replace(/\s+/g, ' ').trim();
            if (cleanText.length > 200) {
                content = cleanText.substring(0, 4000);
            }
        }

        console.log(`ì¶”ì¶œëœ ìš”ì†Œ ìˆ˜: ${extractedElements}`);
        console.log(`ìµœì¢… ì½˜í…ì¸  ê¸¸ì´: ${content.length}`);

        // ì ì ˆí•œ ê¸¸ì´ë¡œ ì œí•œ
        const maxLength = 8000; // í‘œ ë°ì´í„°ë¥¼ í¬í•¨í•˜ë¯€ë¡œ ê¸¸ì´ ì œí•œ ì¦ê°€
        if (content.length > maxLength) {
            content = content.substring(0, maxLength) + '... (ë‚´ìš©ì´ ê¸¸ì–´ ì¼ë¶€ë§Œ í‘œì‹œë©ë‹ˆë‹¤)';
        }

        return `ì œëª©: ${title}\n\në³¸ë¬¸ ë‚´ìš©:\n${content}`;
    }

    // ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
    function addMessage(content, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;

        const messageContent = document.createElement('div');
        // ì‚¬ìš©ì ë©”ì‹œì§€ëŠ” ê·¸ëŒ€ë¡œ í‘œì‹œ, AI ë©”ì‹œì§€ëŠ” ë§ˆí¬ë‹¤ìš´ ë³€í™˜
        if (isUser) {
            messageContent.innerHTML = content.replace(/\n/g, '<br>');
        } else {
            messageContent.innerHTML = markdownToHTML(content);
        }

        const timestamp = document.createElement('div');
        timestamp.className = 'timestamp';
        timestamp.textContent = new Date().toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit'
        });

        messageDiv.appendChild(messageContent);
        messageDiv.appendChild(timestamp);
        chatbotMessages.appendChild(messageDiv);

        // ìŠ¤í¬ë¡¤ì„ ìµœì‹  ë©”ì‹œì§€ë¡œ ì´ë™
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }

    // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í‘œì‹œ/ìˆ¨ê¹€
    function showTypingIndicator(show) {
        if (show) {
            typingIndicator.classList.add('active');
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        } else {
            typingIndicator.classList.remove('active');
        }
    }

    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
    function showError(message) {
        errorMessage.textContent = message;
        setTimeout(() => {
            errorMessage.textContent = '';
        }, 5000);
    }

    // ì•Œë¦¼ í‘œì‹œ
    function showNotification() {
        chatbotNotification.style.display = 'block';
        setTimeout(() => {
            chatbotNotification.style.display = 'none';
        }, 3000);
    }

    // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
    function markdownToHTML(text) {
        let html = text;

        // í—¤ë” ì²˜ë¦¬
        html = html.replace(/^### (.*$)/gm, '<h3 style="color: #667eea; margin: 15px 0 10px 0; font-size: 1.2em;">$1</h3>');
        html = html.replace(/^## (.*$)/gm, '<h2 style="color: #667eea; margin: 20px 0 15px 0; font-size: 1.4em;">$1</h2>');
        html = html.replace(/^# (.*$)/gm, '<h1 style="color: #667eea; margin: 25px 0 20px 0; font-size: 1.6em;">$1</h1>');

        // êµµì€ ê¸€ì”¨ ì²˜ë¦¬
        html = html.replace(/\*\*(.*?)\*\*/g, '<strong style="font-weight: 600; color: #333;">$1</strong>');

        // ê¸°ìš¸ì„ê¼´ ì²˜ë¦¬
        html = html.replace(/\*(.*?)\*/g, '<em style="font-style: italic;">$1</em>');

        // ì¸ë¼ì¸ ì½”ë“œ ì²˜ë¦¬
        html = html.replace(/`(.*?)`/g, '<code style="background: #f8f9fa; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 0.9em;">$1</code>');

        // ë§í¬ ì²˜ë¦¬
        html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" style="color: #667eea; text-decoration: none;" target="_blank">$1</a>');

        // ìˆœì„œ ì—†ëŠ” ëª©ë¡ ì²˜ë¦¬
        html = html.replace(/^[\s]*-[\s]+(.*$)/gm, '<li style="margin: 5px 0; list-style-position: inside;">$1</li>');

        // ìˆœì„œ ìˆëŠ” ëª©ë¡ ì²˜ë¦¬
        html = html.replace(/^[\s]*\d+\.[\s]+(.*$)/gm, '<li style="margin: 5px 0; list-style-position: inside;">$1</li>');

        // ì—°ì†ëœ ëª©ë¡ í•­ëª©ë“¤ì„ ul/olë¡œ ê°ì‹¸ê¸°
        html = html.replace(/(<li[^>]*>.*<\/li>)(\s*<li[^>]*>.*<\/li>)*/gs, (match) => {
            // ìˆœì„œ ìˆëŠ” ëª©ë¡ì¸ì§€ í™•ì¸ (ì›ë³¸ í…ìŠ¤íŠ¸ì—ì„œ íŒ¨í„´ í™•ì¸)
            const originalLines = match.match(/<li[^>]*>(.*?)<\/li>/g) || [];
            const isOrdered = originalLines.some(line => /^\s*\d+\./.test(line.replace(/<[^>]*>/g, '')));

            if (isOrdered) {
                return '<ol style="margin: 10px 0; padding-left: 20px;">' + match + '</ol>';
            } else {
                return '<ul style="margin: 10px 0; padding-left: 20px;">' + match + '</ul>';
            }
        });

        // ì¤„ë°”ê¿ˆ ì²˜ë¦¬
        html = html.replace(/\n\n/g, '</p><p style="margin: 10px 0;">');
        html = html.replace(/\n/g, '<br>');

        // p íƒœê·¸ë¡œ ê°ì‹¸ê¸° (ì´ë¯¸ íƒœê·¸ê°€ ìˆëŠ” ë¶€ë¶„ ì œì™¸)
        html = html.split('<br>').map(line => {
            line = line.trim();
            if (!line) return '';
            if (line.startsWith('<h') || line.startsWith('<ol>') || line.startsWith('<ul>') || line.startsWith('<li>') || line.startsWith('<p>')) {
                return line;
            }
            return '<p style="margin: 10px 0;">' + line + '</p>';
        }).join('<br>');

        return html;
    }

    // AI API ìŠ¤íŠ¸ë¦¬ë° í˜¸ì¶œ í•¨ìˆ˜ (Netlify Functions í”„ë¡ì‹œ ì‚¬ìš©)
    async function callAIStreaming(userMessage, onChunk) {
        // ì„¤ì • ë¡œë“œ í™•ì¸
        if (!configLoaded || configLoadError) {
            throw new Error('ì±—ë´‡ ì„¤ì •ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }

        // API ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        const config = window.CHATBOT_SECURE_CONFIG;
        const API_URL = config.getApiUrl();
        const MODEL = config.MODEL;

        // í˜¸ì¶œ ì œí•œ í™•ì¸
        if (!checkRateLimit()) {
            throw new Error(`ì‹œê°„ë‹¹ ${config.MAX_CALLS}íšŒë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
        }

        const pageContent = extractPageContent();

        const systemPrompt = `ë‹¹ì‹ ì€ ë¸”ë¡œê·¸ì˜ AI ì±—ë´‡ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ì¹œì ˆí•˜ê³  ì •í™•í•˜ê²Œ ë‹µë³€í•´ì£¼ì„¸ìš”.

í˜„ì¬ í˜ì´ì§€ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ë‹µë³€í•˜ì„¸ìš”:
${pageContent}

ë‹µë³€ ì›ì¹™:
1. í˜ì´ì§€ ë‚´ìš©ì´ ìˆë‹¤ë©´ ì´ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ì°¸ê³ í•˜ì„¸ìš”
2. ì‚¬ìš©ìê°€ í˜ì´ì§€ ë‚´ìš©ì— ëŒ€í•´ ë¬¼ì–´ë³´ë©´ ì •í™•íˆ ë‹µë³€í•˜ì„¸ìš”
3. í˜ì´ì§€ ë‚´ìš©ê³¼ ê´€ë ¨ ì—†ëŠ” ì§ˆë¬¸ì´ë©´ ì¼ë°˜ì ì¸ ì •ë³´ë¡œ ë‹µë³€í•˜ì„¸ìš”
4. ë‹µë³€ì€ í•œêµ­ì–´ë¡œ, ì¹œê·¼í•œ ì–´ì¡°ë¡œ ì‘ì„±í•˜ì„¸ìš”
5. ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•´ì„œ ë‹µë³€í•˜ì„¸ìš”`;

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept-Language': 'ko-KR'
                },
                body: JSON.stringify({
                    model: MODEL,
                    messages: [
                        {
                            role: 'system',
                            content: systemPrompt
                        },
                        {
                            role: 'user',
                            content: userMessage
                        }
                    ],
                    stream: true // ìŠ¤íŠ¸ë¦¬ë° í™œì„±í™”
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('API ì‘ë‹µ ì˜¤ë¥˜:', response.status, errorText);
                throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let fullResponse = '';

            while (true) {
                const { done, value } = await reader.read();

                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // ë§ˆì§€ë§‰ ë¶ˆì™„ì „í•œ ë¼ì¸ ì €ì¥

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.slice(6);
                        if (data === '[DONE]') continue;

                        try {
                            const parsed = JSON.parse(data);
                            const content = parsed.choices[0]?.delta?.content || '';
                            if (content) {
                                fullResponse += content;
                                onChunk(content);
                            }
                        } catch (e) {
                            // JSON íŒŒì‹± ì˜¤ë¥˜ ë¬´ì‹œ
                        }
                    }
                }
            }

            return fullResponse;

        } catch (error) {
            console.error('AI API ìŠ¤íŠ¸ë¦¬ë° í˜¸ì¶œ ì˜¤ë¥˜:', error);
            throw new Error('ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ìƒì„±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
    function addStreamingMessage() {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot streaming';

        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';

        const timestamp = document.createElement('div');
        timestamp.className = 'timestamp';
        timestamp.textContent = new Date().toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit'
        });

        messageDiv.appendChild(messageContent);
        messageDiv.appendChild(timestamp);
        chatbotMessages.appendChild(messageDiv);

        // ìŠ¤í¬ë¡¤ì„ ìµœì‹  ë©”ì‹œì§€ë¡œ ì´ë™
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;

        return messageContent;
    }

    // ë©”ì‹œì§€ ì²˜ë¦¬ í•¨ìˆ˜ (ìŠ¤íŠ¸ë¦¬ë°) - API í‚¤ í™•ì¸ ì¶”ê°€
    async function processMessage() {
        const message = chatbotInput.value.trim();
        if (!message || isProcessing) return;

        // API í‚¤ í™•ì¸
        if (!apiKeyManager.hasApiKey()) {
            showError('API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì±—ë´‡ì„ ë‹¤ì‹œ ì—´ì–´ì£¼ì„¸ìš”.');
            return;
        }

        isProcessing = true;
        chatbotSend.disabled = true;
        chatbotInput.value = '';

        // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        addMessage(message, true);

        // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í‘œì‹œ
        showTypingIndicator(true);

        try {
            // ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ìƒì„±
            const streamingContent = addStreamingMessage();
            let currentContent = '';

            // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ìˆ¨ê¹€
            showTypingIndicator(false);

            // AI API ìŠ¤íŠ¸ë¦¬ë° í˜¸ì¶œ
            await callAIStreaming(message, (chunk) => {
                currentContent += chunk;
                // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜í•˜ì—¬ í‘œì‹œ
                streamingContent.innerHTML = markdownToHTML(currentContent);
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            });

            // ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ í›„ ì• ë‹ˆë©”ì´ì…˜ ì œê±°
            const messageDiv = streamingContent.closest('.message');
            if (messageDiv) {
                messageDiv.classList.remove('streaming');
            }

        } catch (error) {
            showTypingIndicator(false);
            showError(error.message);
            addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
            isProcessing = false;
            chatbotSend.disabled = false;
            chatbotInput.focus();
        }
    }

    // ì±—ë´‡ ì—´ê¸°/ë‹«ê¸° (API í‚¤ í™•ì¸ ë¡œì§ ì¶”ê°€)
    function toggleChatbot() {
        if (!isOpen) {
            // ì±—ë´‡ì„ ì—´ë ¤ê³  í•  ë•Œ API í‚¤ê°€ ìˆëŠ”ì§€ í™•ì¸
            if (!apiKeyManager.hasApiKey()) {
                showApiKeyModal();
                return;
            }
        }

        isOpen = !isOpen;
        if (isOpen) {
            openChatbotWindow();
        } else {
            closeChatbotWindow();
        }
    }

    // ì±—ë´‡ ì°½ ì—´ê¸°
    function openChatbotWindow() {
        chatbotWindow.classList.add('active');
        chatbotToggle.setAttribute('aria-expanded', 'true');
        chatbotInput.focus();
        isOpen = true;
    }

    // ì±—ë´‡ ì°½ ë‹«ê¸°
    function closeChatbotWindow() {
        chatbotWindow.classList.remove('active');
        chatbotToggle.setAttribute('aria-expanded', 'false');
        isOpen = false;
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    chatbotToggle.addEventListener('click', toggleChatbot);
    chatbotClose.addEventListener('click', toggleChatbot);

    chatbotSend.addEventListener('click', processMessage);

    chatbotInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            processMessage();
        }
    });

    // API í‚¤ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    apiKeyToggle.addEventListener('click', toggleApiKeyVisibility);
    apiKeyConfirm.addEventListener('click', confirmApiKey);
    apiKeyCancel.addEventListener('click', hideApiKeyModal);

    // API í‚¤ ì…ë ¥ì°½ ì´ë²¤íŠ¸
    apiKeyInput.addEventListener('input', updateApiKeyConfirmButton);
    apiKeyInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            if (!apiKeyConfirm.disabled) {
                confirmApiKey();
            }
        } else if (e.key === 'Escape') {
            hideApiKeyModal();
        }
    });

    // ESC í‚¤ë¡œ ì±—ë´‡ ë˜ëŠ” ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (apiKeyModal.classList.contains('active')) {
                hideApiKeyModal();
            } else if (isOpen) {
                closeChatbotWindow();
            }
        }
    });

    // ì±—ë´‡ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° (ëª¨ë‹¬ì´ í™œì„±í™”ë˜ì§€ ì•Šì•˜ì„ ë•Œë§Œ)
    document.addEventListener('click', (e) => {
        if (apiKeyModal.classList.contains('active')) {
            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
            if (!apiKeyModal.contains(e.target)) {
                hideApiKeyModal();
            }
        } else if (isOpen && !chatbotWindow.contains(e.target) && !chatbotToggle.contains(e.target)) {
            closeChatbotWindow();
        }
    });

    // ì±—ë´‡ ì´ˆê¸°í™”
    initChatbot();

    // ì´ˆê¸°í™” ë©”ì‹œì§€ (5ì´ˆ í›„ ì•Œë¦¼ í‘œì‹œ)
    setTimeout(() => {
        if (!isOpen && configLoaded) {
            showNotification();
        }
    }, 5000);

    console.log('AI ì±—ë´‡ì´ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
})();
</script>
<!-- === END: AI Chatbot Assistant === -->